<!-- Code from d3-graph-gallery.com -->
<!-- Extended from:  https://www.d3-graph-gallery.com/graph/choropleth_hover_effect.html-->
<!-- D3.legend library from: https://d3-legend.susielu.com/-->
<!--TODO: better threshold-->
<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
<script src="https://d3-legend.susielu.com/d3-legend.min.js"></script>

<!-- Create an element where the map will take place -->
<svg id="my_dataviz" width="400" height="500"></svg>
<script>

    // The svg
    var svg = d3.select("#my_dataviz"),
      width = +svg.attr("width"),
      height = +svg.attr("height");
    
    // Map and projection
    var path = d3.geoPath();
    var projection = d3.geoMercator()
      .scale(1500)
      .center([9,50])
      .translate([width / 2, height / 2]);
    
    // Data and color scale
    var data = d3.map();
    var colorScale = d3.scaleThreshold()
      .domain([1000,4000,5000,10000,15000,20000,25000,30000])
      .range(d3.schemeBlues[7]);
    
    // Legend for colorScale:
    var legend = d3.legendColor()
      .title("Hello")
      .labelFormat(d3.format(""))
      .labels(d3.legendHelpers.thresholdLabels) 
      .scale(colorScale)


    // Load external data and boot
    d3.queue()
      .defer(d3.json, "bundeslaender.geojson")
      .defer(d3.csv, "Gelder_Bundesland.csv", function(d) { data.set(d.id, +d.pop); })
      .await(ready);
    

    
function ready(error, topo) {

  let mouseOver = function(d) {
    d3.selectAll(".name")
      .transition()
      .duration(200)
      .style("opacity", .5)
    d3.select(this)
      .transition()
      .duration(200)
      .style("opacity", 1)
      .style("stroke", "black")
  }

  let mouseLeave = function(d) {
    d3.selectAll(".name")
      .transition()
      .duration(200)
      .style("opacity", .8)
    d3.select(this)
      .transition()
      .duration(200)
      .style("stroke", "transparent")
  }
      // Draw the map
      svg.append("g")
        .selectAll("path")
        .data(topo.features)
        .enter()
        .call(legend)
        .append("path")
          // draw each country
          .attr("d", d3.geoPath()
            .projection(projection)
          )
          // set the color of each country
          .attr("fill", function (d) {
            d.total = data.get(d.id) || 0;
            return colorScale(d.total);
          })
      .style("stroke", "transparent")
      .attr("class", function(d){ return "Country" } )
      .style("opacity", .8)
      .on("mouseover", mouseOver )
      .on("mouseleave", mouseLeave )
      }
    </script>